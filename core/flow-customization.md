###背景

我们的负载均衡基于 Openflow 实现 NAT 模式.

OpenFlow 的基本思想是: 将交换机中流表控制功能由专门的外部服务器来控制(即下文所述控制器), 而交换机只负责根据流表规则进行转发. 即将转发和控制分离

NAT 模式基本思想是: 负载均衡网关接受客户端请求, 控制器根据算法选择一台网关后端的服务器 S 来处理客户端请求. 因此, 网关每接受一个请求需要在交换机上创建至少一条流表.


**入方向**

        匹配: src_ip + src_port + dst_ip + dst_port
        修改: dst_mac 为 S 的 mac 地址,  dst_ip  为 S 的 ip 地址, dst_port 为 S 端口

        注: src_ip 为 客户端ip, dst_ip 为 网关 ip

**出方向**

        匹配: src_ip + src_port
        修改: src_mac 为网关的MAC, src_ip 为网关的 ip, src_port 为网关的端口

        注: src_ip 为S ip 地址, src_port 为 S 的 port

在我们的业务场景下, 客户端数量:负载均衡网关下的后端服务器数量 = N:1, ( N 小于 10. 甚至更小) . 为了保证同一客户端的
不同端口**必须**负载到不同的后端服务器, 因此匹配域中匹配了客户端的 port. 在这种情况下, 如果客户端以 100 request/s 请求网关, 不到 20 秒就会在交换机上创建 2000 条流表(这里的流表也可以理解为链路).

现有的商业交换机一般的流表数量 2k 左右. 而一般流表过期(即链路过期)时间至少为 60 s, 在这种情况下, 交换机流表填满后,
删除旧的流表,并且在控制器下缓存已经创建的流表来保持链路. 此外, 我们的目标是支持 10000 request/s, 因此 2k 的流表项
根本无法满足我们的需求. 因此, 需要交换机芯片厂商根据业务需要对交换机的流表进行定制.


经过与[盛科](http://www.centecnetworks.com/cn/Main.asp)沟通, 他们愿意为我们提供流表定制. 流表定制及其目前情况如下:

###模式1

1. 出方向，要能匹配  src_ip + src_port, action 是 mod src_mac + src_ip + mod src_port + output to port
这种流表项数量大约 1000 条左右。

2. 入方向，要能匹配 src_ip + src_port + dst_ip + dst_port, action是mod dst_mac + dst_ip + dst_port, output to port
这种流表项数量至少为 15 K，甚至更大。

3.  无论入方向还是出方向，都需要能够匹配 L2-L4 的 wildcard 这种流表项数量很少，500条左右  优先级低于 65535。

###模式2 :

在 default(具体见附件V350配置手册的第8页) 的基础上增加端口模糊匹配, 这样可以根据客户端的端口范围来创建流表
由于引入端口模糊匹配, 在此种模式下, 如果一条流表的匹配的端口范围是10, 那么可以认为是模式1 情况下的 20000 条流表



###两种模式的对比:

####模式1 :

优点: 每次客户端的新请求都能均匀地负载到网关下不同的后端服务器, 算法与传统的负载均衡策略基本一致, 且算法简单, 云网关项目目前的采用的方法
缺点: 每次建立连接都需要经过控制器, 响应速度慢, 且控制器的负载很大

####模式2 :

优点: 客户端的绝大多少数请求直接通过交换机, 响应速度非常好
缺点: 客户端的请求基本能均匀地负载到网关下的不同服务器, 但是对控制器的算法有较高的要求, 负载均衡功能需要抛弃之前的算法,我初步的算法见附件

注: 两种模式都可定制,但是两种模式不能同时使用, 切换模式必须重启交换机.

####共同的缺点:

在高负载的情况下

1. 网关新增加服务器两种模式都存在无法立即参与负载均衡功能的可能性(目前已经由解决思路, 具体可行性正在验证中)
2. 在 1 可行的情况下, 模式一, 由于新建的连接都要经过控制器, 而控制器的的处理能力最大为 500 请求/s(原因是理论上一个包从控制器->交换机->后端服务器
的最短时间为 2 ms), 因此在高负载情况下,模式一存在客户端超时时无法获取服务器的请求.
3. 在 1 可行的情况下, 模式二负载迁移到新增服务器的速度很慢.

###定制费用情况

单一模式订制费用: 首付5万, 后续每购买1台交换机, 返回 2000 元, 当购买量到 25 台时, 可以认为是免费定制.
两种模式都订制费用: 首付 8 万, 后续每购买1台交换机, 返回 2500 元,当购买量达到 32 台, 可以认为是免费定制
