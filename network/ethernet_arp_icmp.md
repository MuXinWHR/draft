


##以太网

###以太网帧格式

	目的网卡地址		源网卡地址	下一条协议		数据		   检验位
	  6 byte		      6 byte	 2 byte      >46 < 1500        4 byte

###以太网帧由5个字段组成

* 前两个字段分别为6字节长的目的地址和源地址地段。
* 第三个字段是 2 字节的类型字段，用来标志上一层使用的是什么协议。

	类型字段的值为0x0800时，表示上层使用的是IP数据报。
	类型字段的值为0x0806时，表示上层为ARP数据报
	类型字段的值为0x8137时，表示该帧是有Novell IPX发过来的。

* 第四个字段是数据段:长度在 46 到 1500 字节之间
* 第五个字段是 4 字节的帧检验序列 FCS.

**注**

以太网最小长度是 64 字节, 减去 18 字节的(首部和尾部)得出数据段最小为 46 字节, 首部 14 字节，尾部 4 字节的效验码
当数据字段的长度小于 46 字节时, 会在数据字段的后面加入一个整数字节的填充字段, 以保证以太网的 MAC 帧长度不小
于 64 字节。

以太网封装 IP 数据包的最大长度是 1500 字节，也就是说以太网最大帧长应该是以太网首部加上1500，再加上 7 字节的前导同步码和
1 字节的帧开始定界符，具体就是：7字节前导同步吗＋1字节帧开始定界符＋6字节的目的MAC＋6字节的源MAC＋2字节的帧类型＋1500＋4字节的FCS。

按照上述，最大帧应该是 1526 字节，但是实际上我们抓包得到的最大帧是 1514 字节，为什么不是 1526 字节呢？原因是当数据帧到达网卡时，
在物理层上网卡要先去掉前导同步码和帧开始定界符，然后对帧进行 CRC 检验，如果帧校验和错，就丢弃此帧。如果校验和正确，就判断帧的目的
硬件地址是否符合自己的接收条件（目的地址是自己的物理硬件地址、广播地址、可接收的多播硬件地址等），如果符合，就将帧交“设备驱动程序”
做进一步处理。这时我们的抓包软件才能抓到数据，因此，抓包软件抓到的是去掉前导同步码、帧开始分界符、FCS之外的数据，
其最大值是6＋6＋2＋1500＝1514。

以太网规定，以太网帧数据域部分最小为 46 字节，也就是以太网帧最小是 6＋6＋2＋46＋4＝64。除去4个字节的FCS，因此，抓包时就是 60 字节。
当数据字段的长度小于 46 字节时，MAC 子层就会在数据字段的后面填充以满足数据帧长不小于 64 字节。由于填充数据是由 MAC 子层负责，
也就是设备驱动程序。不同的抓包程序和设备驱动程序所处的优先层次可能不同，抓包程序的优先级可能比设备驱动程序更高，也就是说，我们的抓
包程序可能在设备驱动程序还没有填充不到 64 字节的帧的时候，抓包程序已经捕获了数据。因此不同的抓包工具抓到的数据帧的大小可能不同

###以太网速率计算

我们通常所说的 10M、100M，1000M、10GE，这些都是指物理介质每秒可以传送多少 bit 的数据。在我们实际中经常使用每秒传送实际数
据帧的数目即 PPS（packets per second）来表示报文的速率。下面介绍对于以太网来说如何进行链路速率与 pps 之间的换算。

以太网传送数据时，每两个帧之间存在帧间隙 IFG（Inter Frame Gap），帧间隙的作用是使介质中的信号处于稳定状态，同时让帧接收者
对接收的帧作必要的处理（如调整缓存取的指针、更新计数、发中断让主机对报文进行处理）。对于 Ethernet（10M） 帧间隙时间为
9.6usec，100M 快速以太网帧间隙为 0.96usec，1000M 帧间隙为 0.096usec，10GE 帧间隙为 0.0096usec，这个时间正好相当于传送 96bit
数据的时间。

下面我们看怎么把以太网速率与 pps 进行换算，假设数据帧的长度为 k bytes（包括CRC），端口速率为 R，转化后的 PPS 为 N，那么：

            N＝R/(k×8＋8×8＋96)

其中 k×8 表示实际数据帧的长度(bits)，8×8表示前导码(Preamble＋SFD)的长度, 96bit 相当于帧间隙占用的 bits。

下面举例说明，假设端口速率为 100M，发送数据帧的长度为 64 字节，那么线速发送报文换算成pps后，

     N＝100 000 000/（64×8＋8×8＋96）≈148810 pps

##ARP

###什么是ARP ?

ARP (Address Resolution Protocol) 是个地址解析协议。最直白的说法是：在IP以太网中，当一个上层协议要发包时，有了该节点的IP地址，ARP就能提供该节点的MAC地址。

###为什么要有ARP？

OSI 模式把网络工作分为七层，彼此不直接打交道，只通过接口(layre interface). IP地址在第三层, MAC地址在第二层。

协议在发生数据包时，首先要封装第三层 （IP地址）和第二层 （MAC地址）的报头, 但协议只知道目的节点的IP地址，不知道其物理地址，又不能跨第二、三层，所以得用ARP的服务。

###详细说明：

在网络通讯时，源主机的应用程序知道目的主机的IP地址和端口号，却不知道目的主机的硬件地址，而数据包首先是被网卡接收
到再去处理上层协议的，如果接收到的数据包的硬件地址与本机不符，则直接丢弃。因此在通讯前必须获得目的主机的硬件地址。
ARP协议就起到这个作用

当一台主机把以太网数据帧发送到位于同一局域网上的另一台主机时，是根据 48位的以太网地址来确定目的接口的，设备驱动程序从不检查 IP
数据报中的目的IP地址。ARP（地址解析）模块的功能为这两种不同的地址形式提供映射：32位的 IP地址和 48位的以太网地址


###ARP报文各字段含义

	硬件类型	协议类型	硬件地址长度	协议地址长度	操作类型	源MAC物理地址 源IP地址 目标MAC物理地址	目的IP地址
	   2            2           1               1               2           6            4         6                4

硬件类型：占2个字节，表明ARP实现在何种类型的网络上。

	值为1：表示以太网。

协议类型：占2个字节表示要映射的协议地址类型。

	IP:0800

操作类型 ：占2个字节，表示ARP数据包类型。

	值为1表示ARP请求。
	值2表示ARP应答。

源MAC地址：占6个字节，表示发送端MAC地址

源IP地址: 占4个字节，表示发送端IP地址

目的以太网地址：占6个字节，表示目标设备的MAC物理地址

目的IP地址：占4个字节，表示目标设备的IP地址.

**注**

在ARP操作中，有效数据的长度为28个字节，不足以太网的最小长度46字节长度，需要填充字节，填充字节最小长度为18个字节

在发送ARP请求时，以太网帧头中的目的MAC物理地址为 FF-FF-FF-FF-FF-FF, 而在ARP帧中的目的MAC处此时为空。

###ARP协议工作过程：

在局域网中，网络中实际传输的是"帧"，帧里面是有目标主机的MAC地址的。

在以太网中，一个主机要和另一个主机进行直接通信，必须要知道目标主机的MAC地址。但这个目标MAC地址是如何获得呢？
它就是通过地址解析协议获得的。所谓"地址解析"就是主机在发送帧前将目标IP地址转换成目标MAC地址的过程。

ARP协议的基本功能就是通过目标设备的IP地址，查询目标设备的MAC地址，以保证通信的顺利进行。

通信过程

当主机A向本局域网上的某个主机B发送IP数据报时，就先在自己的ARP缓冲表中查看有无主机B的IP地址。

如果有，就可以查出其对应的硬件地址，再将此硬件地址写入MAC帧，然后通过以太网将数据包发送到目的主机中。

如果查不到主机B的IP地址的表项。可能是主机B才入网，也可能是主机A刚刚加电。其高速缓冲表还是空的。在这中情况下，主机A就自动运行ARP。

ARP进程在本局域网上广播一个ARP请求分组。ARP请求分组的主要内容是表明：目的MAC地址是FF-FF-FF-FF-FF-FF，ARP命令类型为REQUEST（1）IP地址是192.168.0.2，源硬件地址是00-00-C0-15-AD-18. 目的 IP地址为192.168.0.4的主机的硬件地址，。

在本局域网上的所有主机上运行的ARP进行都收到此ARP请求分组。

主机B在ARP请求分组中见到自己的IP地址，就向主机A发送ARP响应分组，并写入自己的硬件地址。其余的所有主机都不理睬这个ARP请求分组。
ARP响应分组的主要内容是表明：“我的IP地址是192.168.0.4,我的硬件地址是08-00-2B-00-EE-AA”,请注意：虽然ARP请求分组是广播发送的，
但ARP响应分组是普通的单播，即从一个源地址发送到一个目的地址。

主机A收到主机B的ARP响应分组后，就在其ARP高速缓冲表中写入主机B的IP地址到硬件地址的映射。

###ARP命令：

使用arp-a命令就可以查看本地的ARP缓存内容，所以，执行一个本地的PING命令后，ARP缓存就会存在一个目的IP的记录了。

使用arp –d来删除ARP高速缓存中的某一项内容

使用arp –s来增加高速缓冲表中的内容，这个命令需要主机名和以太网地址。新增加的内容是永久性的，除非在命令行的末尾加上关键字temp。

arp –s 157.55.85.212  00-aa-aa-562-c6-09

增加一个静态的ARP表项。

arppub –s:使系统起着主机ARP代理功能。系统将回答与主机名对应的IP地址的ARP请求。


##ICMP

###概述

	IP首部			ICMP报文

 ICMP允许主机或路由报告差错情况和提供有关异常情况。ICMP是因特网的标准协议，但ICMP不是高层协议，而是IP层的协议。通常ICMP报文被IP层或更高层协议（TCP或UDP）使用。一些ICMP报文把差错报文返回给用户进程。

ICMP报文作为IP层数据报的数据，加上数据报的首部，组成数据报发送出去。

ICMP报文的种类有两种，即ICMP差错报告报文和ICMP询问报文。

###ICMP报文的格式

		类型(0或8) 代码(0)	检验和
		标识符				序号
				选项数据

ICMP报文的前4个字节是统一的格式，共有三个字段：即类型，代码和检验和。

8位类型和8位代码字段一起决定了ICMP报文的类型。

	类型8，代码0：表示回显请求(ping请求)。

	类型0，代码0：表示回显应答(ping应答)

	类型11，代码0：超时

16位的检验和字段：包括数据在内的整个ICMP数据包的检验和；其计算方法和IP头部检验和的计算方法一样的。

ICMP报文具体分为查询报文和差错报文(对ICMP差错报文有时需要做特殊处理，因此要对其进行区分。如：对ICMP差错报文进行响应时，永远不会生成另一份ICMP差错报文，否则会出现死循环)


###ICMP差错报文(56字节)

ICMP差错报告报文共有5种

终点不可达：终点不可达分为:网络不可达，主机不可达，协议不可达，端口不可达，需要分片但DF比特已置为1，以及源路由失败等六种情况，其代码字段分别置为0至5。当出现以上六种情况时就向源站发送终点不可达报文。

说明：

端口不可达：UDP的规则之一是：如果收到UDP数据报而且目的端口与某个正在使用的进程不相符，那么UDP返回一个ICMP不可达报文。

源站抑制：当路由器或主机由于拥塞而丢弃数据报时，就向源站发送源站抑制报文，使源站知道应当将数据报的发送速率放慢。

时间超过：当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向源站发送时间超过报文。当目的站在预先规定的时间内不能收到一个数据报的全部数据报片时，就将已收到的数据报片都丢弃，并向源站发送时间超过报文。

参数问题：当路由器或目的主机收到的数据报的首部中的字段的值不正确时，就丢弃该数据报，并向源站发送参数问题报文。

改变路由（重定向）路由器将改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器。

说明:

以下几种情况都不会导致产生ICMP差错报文

	ICMP差错报文（但是，ICMP查询报文可能会产生ICMP差错报文）
	目的地址是广播地址或多播地址的IP数据报
	作为链路层广播的数据报
	不是IP分片的第一片
	源地址不是单个主机的数据报。即源地址不能为零地址、环回地址、广播地址或多播地址

这些规则是为了防止过去允许ICMP差错报文对广播分组响应所带来的广播风暴。


所有的ICMP差错报告报文中的数据字段都具有同样的格式。将收到的需要进行差错报告IP数据报的首部和数据字段的前8个字节提取出来，作为ICMP报文的数据字段。再加上响应的ICMP差错报告报文的前8个字节，就构成了ICMP差错报告报文。提取收到的数据报的数据字段的前8个字节是为了得到运输层的端口号（对于TCP和UDP）以及运输层报文的发送序号（对于TCP）。


	IP数据报首部	 | ICMP前8个字节	 | IP数据报首部 |  8个字节 |
				 |       ICMP 差错报文                    |
		                         |  收到的 IP 数据报      |

###ICMP询问报文（40字节）

ICMP询问报文有四种回送请求和回答，时间戳请求和回答，掩码地址请求和回答，以及路由器询问和通过。

ICMP回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的机器必须给源主机发送ICMP回送应答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态。

ICMP时间戳请求允许系统向另一个系统查询当前的时间。该ICMP报文的好处是它提供了毫秒级的分辨率，而利用其他方法从别的主机获取的时间只能提供秒级的分辨率。请求端填写发起时间，然后发送报文。应答系统收到请求报文时填写接收时间戳，在发送应答时填写发送时间戳。大多数的实现是把后面两个字段都设成相同的值。

主机使用ICMP地址掩码请求报文可向子网掩码服务器得到某个接口的地址掩码。系统广播它的ICMP请求报文。ICMP报文中的标识符和序列号字段由发送端任意选择设定，这些值在应答中将被返回，这样，发送端就可以把应答与请求进行匹配。

主机使用ICMP路由器询问和通过报文可了解连接在本网络上的路由器是否正常工作。主机将路由器询问报文进行广播（或多播）。收到询问报文的一个或几个路由器就使用路由器通过报文广播其路由选择信息



##附录

传统的以太网是共享性局域网，采用载波侦听多路访问/冲突检测CSMA/CD协议。最小帧长必须大于整个网络的最大时延位（最大时延时间内可以传输的数据位）

如果帧长度太小，就可能出现网络上同时有两个帧在传播，就会产生冲突（碰撞）而造成网络无法发送数据。

如果数据帧太长就会出现有的工作长时间不能发送数据，而且可能超出接收端的缓冲区大小，造成缓冲益出。

由于多方面的限制，每个以太网帧都有最小的大小64bytes最大不能超过1518bytes，对于小于或者大于这个限制的以太网帧我们都可以视之为错误的数据帧，一般的以太网转发设备会丢弃这些数据帧。

小于64Bytes的数据帧一般是由于以太网冲突产生的“碎片”或者线路干扰或者坏的以太网接口产生的，对于大于

1518Bytes的数据帧我们一般把它叫做Giant帧，这种一般是由于线路干扰或者坏的以太网口产生）

