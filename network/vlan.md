
IEEE 提出了 802.1Q 标准，这个标准也可以称为 VLAN 技术的标准，在这个标准中定义了上面提到的 VLAN 标签，同时吸纳了 802.1P
的成果，在以太网上引入了优先级的概念，并制定了 VLAN 标准在未来一段时间内的发展方向，形成的 802.1Q 标准在业界获得了广泛
的推广，它成为 VLAN 史上的一块里程碑。802.1Q 的出现打破了虚拟网依赖于单一厂商的僵局，从一个侧面推动了 VLAN 的迅速发展。

##VLAN成员连接方式

VLAN成员的连接方式分为三种：Access,Trunk,Hybrid;

* Access 连接：报文不带 tag 标签,一般用于和 tag-unaware(不支持802.1Q封装)设备相连，或者不需要区分不同 VLAN 成员时使用；
* Trunk  连接：在 PVID 所属的 VLAN 不带 tag 标签转发,其他 VLAN 中的报文都必须带 tag 标签，用于 tag-aware(支持802.1Q封装)
设备相连，一般用于交换机之间的互连；
* Hybrid 连接：可根据需要设置某些 VLAN 报文带 tag, 某些报文不带 tag。与 trunk 连接最大的不同在于，trunk 连接只有 PVID
所属的 VLAN 不带 tag,其他 VLAN 都必须带 tag,而 Hybrid 连接是可以设置多个 VLAN 不带 tag；

实际应用中，根据设置设备端口的 Access、Trunk、Hybrid 属性来实现各种不同的连接方式。端口属性的应用也远远超出了简单的 VLAN
成员互连


##Tag/Untag报文的处理原则

为了理解 VLAN 内报文的转发，就必须要知道交换机对于不同 VLAN 报文的 tag/untag 的处理原则。

首先，需要明确一点就是，在交换机的内部，为了快速高效的处理，报文都是带tag转发的。其实，这点很好理解，因为交换机上很
可能会配置多个 VLAN,那不同 VLAN 流量区分只有依靠 tag 标签。

下面从报文入和报文出两个方向来介绍。

###报文入方向：

在入方向上，交换机的根本任务就是决定该报文是否允许进入该端口，根据入报文的tag/untag的属性以及端口属性，细分为如下情况：

* 报文为 untag: 允许报文进入该端口，并打上 PVID 的 VLAN tag, 与端口属性无关；
* 报文为 tag:  在这种情况下，需要交换机来判断是否允许该报文进入端口；

    Access端口： PVID 和报文中 tag 标明的VLAN一致，接收并处理报文；否则丢弃。
    Trunk/Hybrid端口：如果端口允许 tag 中标明的 VLAN

通过，则接收并处理报文；否则丢弃。

###报文出方向：

在出方向上，交换机已经完成对报文的转发，其根本任务就是在转发出端口时，是否携带 tag 转发出去，根据出端口属性，细分为如下情况：

* Access端口：将标签剥掉，不带 tag 转发；
* Trunk端口：报文所在 VLAN 和 PVID 相同，则报文不带 tag；否则带 tag；
* Hybrid端口：报文所在 VLAN 配置为 tag，则报文带 tag；否则不带 tag；

##VLAN 划分方式

VLAN在交换机上的实现方式，主要有以下几种：

基于端口：

最为常用的划分方式，据以太网交换机的端口来划分。这种划分的方法的优点是定义 VLAN 成员时非常简单，只要将所有的端口都指定一下
就可以了。它的缺点是，如果 VLAN A 的用户离开了原来的端口，到了一个新的交换机的某个端口，那么就必须重新定义。

基于子网：

这种划分 VLAN 的方法是根据每个主机的网络层地址划分的，虽然这种划分方法是根据网络地址，比如 IP 地址，但它不是路由，与网络层的
路由毫无关系。这种方法的优点是用户的物理位置改变了，不需要重新配置所属的 VLAN，还有，它不需要附加的帧标签来识别 VLAN，这样可
以减少网络的通信量。这种方法的缺点是效率低，因为检查每一个数据包的网络层地址是需要消耗处理时间的，一般的交换机芯片都可以自动
检查网络上数据包的以太网帧头，但要让芯片能检查IP帧头，需要更高的技术，同时更费时。

基于MAC：

这种划分 VLAN 的方法是根据每个主机的 MAC 地址来划分，即对每个 MAC 地址的主机都配置它属于哪个组。这种划分 VLAN 的方法的最大优点
就是当用户物理位置移动时，即从一个交换机换到其他的交换机时，VLAN 不用重新配置，可以认为这种根据 MAC 地址的划分方法是基于用户
的 VLAN，这种方法的缺点是初始化时，所有的用户都必须进行配置，如果有几百个甚至上千个用户的话，配置量是很大的，而且这种划分的方法
也导致了交换机执行效率的降低，因为在每一个交换机的端口都可能存在很多个 VLAN 组的成员，这样就无法限制广播包了。

基于协议：

协议 VLAN 与上面介绍的两种实现方式的原理类似，都是根据数据报文的某个特征进行 VLAN 的划分，只是关注的特征不同。基于协议的 VLAN
通过识别报文的协议类型和封装格式进行VLAN的划分,如IP、IPX、AppleTalk协议族；Ethernet II，802.3，802.3/802.2 LLC， 802.3/802.2
SNAP等封装格式。这种实现方式的优缺点与上面的实现方式类似，效率不高。目前,IEEE 802.1v规定了基于端口和协议（port-and-protocal based
VLAN）的标准草案
